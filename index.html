<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembayaran Sekolah Pro</title>

    <!-- Bootstrap + FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); color: white; }
        .status-lunas { color: #1cc88a; font-weight: bold; }
        .status-hutang { color: #e74a3b; font-weight: bold; }

        /* PRINT */
        @media print {
            body * { visibility: hidden !important; }
            #area-print, #area-print * { visibility: visible !important; }
            #area-print { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div class="container py-4">
    <header class="mb-4 text-center">
        <h1 class="fw-bold text-primary"><i class="fas fa-school"></i> Manajemen Pembayaran Sekolah</h1>
        <p class="text-muted">Sistem Pencatatan Keuangan Siswa & Pembayaran Insidental</p>
    </header>

    <!-- DASHBOARD -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h6>Total Siswa</h6>
                    <h2 id="dash-total-siswa">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h6>Total Uang Masuk</h6>
                    <h2 id="dash-uang-masuk">Rp 0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white h-100">
                <div class="card-body text-center">
                    <h6>Total Tunggakan</h6>
                    <h2 id="dash-tunggakan">Rp 0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SYSTEM -->
    <div class="row">
        <div class="col-lg-4">

            <!-- SETTING -->
            <div class="card">
                <div class="card-header bg-secondary text-white">Pengaturan Awal</div>
                <div class="card-body">
                    <label class="form-label">Default Biaya Pokok Masuk</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Rp</span>
                        <input type="number" id="setting-biaya-pokok" class="form-control" value="1000000">
                    </div>
                </div>
            </div>

            <!-- FORM SISWA -->
            <div class="card">
                <div class="card-header bg-info text-white"><i class="fas fa-user-plus"></i> Tambah Siswa</div>
                <div class="card-body">
                    <form id="form-siswa">
                        <div class="mb-3">
                            <label class="form-label">Nama</label>
                            <input type="text" id="nama" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Kelas</label>
                            <input type="text" id="kelas" class="form-control" required>
                        </div>

                        <button class="btn btn-info text-white w-100">Simpan Siswa</button>
                    </form>
                </div>
            </div>

            <!-- FORM TRANSAKSI -->
            <div class="card">
                <div class="card-header bg-gradient-primary"><i class="fas fa-money-bill-wave"></i> Input Transaksi</div>
                <div class="card-body">
                    <form id="form-transaksi">
                        <div class="mb-3">
                            <label class="form-label">Pilih Siswa</label>
                            <select id="siswa-select" class="form-select" required>
                                <option value="">-- Pilih --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Jenis Transaksi</label>
                            <select id="jenis-transaksi" class="form-select" onchange="toggleInputMode()">
                                <option value="bayar_tagihan">Pembayaran</option>
                                <option value="tambah_tagihan">Tambah Tagihan</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Keterangan</label>
                            <input id="ket-transaksi" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label id="label-nominal" class="form-label">Nominal (Rp)</label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" id="nominal" min="0" class="form-control" required>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100">Simpan Transaksi</button>
                    </form>
                </div>
            </div>

            <button onclick="exportCSV()" class="btn btn-success w-100 mb-2"><i class="fas fa-file-csv"></i> Download CSV</button>
            <button onclick="resetData()" class="btn btn-outline-danger w-100 btn-sm">Reset Semua Data</button>

        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="text-primary">Daftar Keuangan Siswa</h5>
                    <input type="text" id="search-box" class="form-control form-control-sm mt-2" placeholder="Cari nama..." onkeyup="renderDaftar()">
                </div>
                <div class="card-body p-0">
                    <div id="daftar-siswa-container" style="max-height:700px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AREA PRINT -->
<div id="area-print" class="d-none">
    <div class="text-center">
        <h2>LAPORAN KEUANGAN SISWA</h2>
        <p>Tanggal Cetak: <span id="print-date"></span></p>
    </div>
    <div id="print-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ===============================
    STATE & UTIL
=================================*/

let siswaData = JSON.parse(localStorage.getItem('sekolahDataPro')) || [];

const formatRupiah = n =>
    new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n);

const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

function saveToLocal() {
    localStorage.setItem('sekolahDataPro', JSON.stringify(siswaData));
    updateDashboard();
}

/* ===============================
    DASHBOARD
=================================*/
function updateDashboard() {
    let totalSiswa = siswaData.length;
    let totalMasuk = 0;
    let totalTagihan = 0;

    siswaData.forEach(s => {
        s.histori.forEach(h => {
            if (h.tipe === "masuk") totalMasuk += h.nominal;
            if (h.tipe === "tagihan") totalTagihan += h.nominal;
        });
    });

    document.getElementById('dash-total-siswa').innerText = totalSiswa;
    document.getElementById('dash-uang-masuk').innerText = formatRupiah(totalMasuk);
    document.getElementById('dash-tunggakan').innerText = formatRupiah(totalTagihan - totalMasuk);
}

/* ===============================
    RENDER SELECT SISWA
=================================*/
function loadSiswaSelect() {
    const sel = document.getElementById('siswa-select');
    sel.innerHTML = '<option value="">-- Pilih --</option>';
    siswaData.forEach(s => {
        sel.innerHTML += `<option value="${s.id}">${s.nama} - ${s.kelas}</option>`;
    });
}

/* ===============================
    RENDER DAFTAR
=================================*/
function renderDaftar() {
    const box = document.getElementById('daftar-siswa-container');
    const keyword = document.getElementById('search-box').value.toLowerCase();

    box.innerHTML = "";

    let filtered = siswaData.filter(s =>
        s.nama.toLowerCase().includes(keyword) ||
        s.kelas.toLowerCase().includes(keyword)
    );

    if (filtered.length === 0) {
        box.innerHTML = `<div class="p-4 text-center text-muted">Tidak ada data.</div>`;
        return;
    }

    filtered.forEach(siswa => {

        let tagihan=0, bayar=0;
        siswa.histori.forEach(h => {
            if (h.tipe === "tagihan") tagihan += h.nominal;
            else bayar += h.nominal;
        });

        const kurang = tagihan - bayar;

        const card = document.createElement("div");
        card.className = "border-bottom p-3";

        card.innerHTML = `
            <div class="d-flex justify-content-between">
                <div>
                    <h5>${siswa.nama} 
                        <span class="badge bg-secondary">${siswa.kelas}</span>
                    </h5>
                    <div class="text-muted small">
                        Tagihan: ${formatRupiah(tagihan)} | Bayar: ${formatRupiah(bayar)}
                    </div>
                    <div class="${kurang<=0 ? 'status-lunas':'status-hutang'}">
                        ${kurang<=0 ? 'LUNAS' : 'Kurang '+formatRupiah(kurang)}
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-dark" onclick="printSiswa('${siswa.id}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="hapusSiswa('${siswa.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <button class="btn btn-light btn-sm mt-2" data-bs-toggle="collapse" data-bs-target="#h${siswa.id}">
                Rincian
            </button>

            <div class="collapse mt-2" id="h${siswa.id}">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Tagihan</th>
                            <th>Bayar</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${siswa.histori.sort((a,b)=>b.timestamp-a.timestamp).map(h=>`
                        <tr>
                            <td>${new Date(h.timestamp).toLocaleDateString('id-ID')}</td>
                            <td>${h.tipe==="tagihan" ? "TAGIHAN" : "BAYAR"} - ${h.keterangan}</td>
                            <td class="text-danger">${h.tipe==="tagihan"?formatRupiah(h.nominal):"-"}</td>
                            <td class="text-success">${h.tipe==="masuk"?formatRupiah(h.nominal):"-"}</td>
                            <td><button class="btn btn-sm text-danger" onclick="hapusTransaksi('${siswa.id}','${h.id}')"><i class="fas fa-times"></i></button></td>
                        </tr>`).join("")}
                    </tbody>
                </table>
            </div>
        `;

        box.appendChild(card);
    });
}

/* ===============================
    HANDLER FORM SISWA
=================================*/
document.getElementById('form-siswa').onsubmit = e => {
    e.preventDefault();

    const nama = document.getElementById('nama').value;
    const kelas = document.getElementById('kelas').value;
    const biayaAwal = parseInt(document.getElementById('setting-biaya-pokok').value);

    siswaData.push({
        id: generateId(),
        nama, kelas,
        histori: [{
            id: generateId(),
            tipe: "tagihan",
            keterangan: "Biaya Pokok Masuk",
            nominal: biayaAwal,
            timestamp: Date.now()
        }]
    });

    saveToLocal();
    loadSiswaSelect();
    renderDaftar();
    e.target.reset();

    Swal.fire("Sukses", "Siswa ditambahkan", "success");
};

/* ===============================
    HANDLER TRANSAKSI
=================================*/
document.getElementById('form-transaksi').onsubmit = e => {
    e.preventDefault();

    const id = document.getElementById('siswa-select').value;
    const jenis = document.getElementById('jenis-transaksi').value;
    const ket = document.getElementById('ket-transaksi').value;
    const nominal = parseInt(document.getElementById('nominal').value);

    if (!id) return Swal.fire("Error", "Pilih siswa dulu", "error");

    const s = siswaData.find(s => s.id === id);

    s.histori.push({
        id: generateId(),
        tipe: jenis === 'tambah_tagihan' ? 'tagihan' : 'masuk',
        keterangan: ket,
        nominal,
        timestamp: Date.now()
    });

    saveToLocal();
    renderDaftar();
    e.target.reset();

    Swal.fire("Sukses", "Transaksi disimpan", "success");
};

function toggleInputMode() {
    const jenis = document.getElementById('jenis-transaksi').value;
    const label = document.getElementById('label-nominal');

    if (jenis === 'tambah_tagihan') {
        label.innerHTML = "Besar Tagihan (Menambah Hutang)";
        label.className = "form-label text-danger fw-bold";
    } else {
        label.innerHTML = "Jumlah Pembayaran (Mengurangi Hutang)";
        label.className = "form-label text-success fw-bold";
    }
}

/* ===============================
    DELETE
=================================*/
function hapusSiswa(id) {
    Swal.fire({
        title: "Yakin hapus siswa?",
        text: "Semua data transaksi akan hilang!",
        icon: "warning",
        showCancelButton: true
    }).then(res => {
        if (res.isConfirmed) {
            siswaData = siswaData.filter(s => s.id !== id);
            saveToLocal();
            loadSiswaSelect();
            renderDaftar();
        }
    })
}

function hapusTransaksi(siswaId, transId) {
    if (!confirm("Hapus transaksi ini?")) return;

    const s = siswaData.find(s => s.id === siswaId);
    s.histori = s.histori.filter(h => h.id !== transId);

    saveToLocal();
    renderDaftar();
}

/* ===============================
    RESET
=================================*/
function resetData() {
    if (!confirm("Hapus SEMUA data?")) return;

    siswaData = [];
    saveToLocal();
    loadSiswaSelect();
    renderDaftar();
}

/* ===============================
    EXPORT CSV
=================================*/
function exportCSV() {
    if (siswaData.length === 0) {
        Swal.fire("Info", "Tidak ada data", "info");
        return;
    }

    let csv = "ID,Nama,Kelas,Tanggal,Jenis,Keterangan,Nominal\n";

    siswaData.forEach(s => {
        s.histori.forEach(h => {
            csv += `"${s.id}","${s.nama}","${s.kelas}","${new Date(h.timestamp).toLocaleDateString('id-ID')}","${h.tipe}","${h.keterangan}",${h.nominal}\n`;
        });
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "laporan_keuangan_sekolah.csv";
    link.click();
}

/* ===============================
    PRINT SISWA
=================================*/
function printSiswa(id) {
    const s = siswaData.find(x => x.id === id);
    if (!s) return;

    let tagihan=0, bayar=0;
    s.histori.forEach(h=>{
        if(h.tipe==="tagihan") tagihan+=h.nominal;
        else bayar+=h.nominal;
    });

    let html = `
        <h3>Laporan Keuangan Siswa</h3>
        <hr>
        <table style="width:100%; margin-bottom:20px;">
            <tr><td>Nama</td><td>: ${s.nama}</td></tr>
            <tr><td>Kelas</td><td>: ${s.kelas}</td></tr>
            <tr><td>Total Tagihan</td><td>: ${formatRupiah(tagihan)}</td></tr>
            <tr><td>Total Bayar</td><td>: ${formatRupiah(bayar)}</td></tr>
            <tr><td>Kekurangan</td><td>: ${formatRupiah(tagihan-bayar)}</td></tr>
        </table>

        <h5>Rincian Transaksi</h5>
        <table border="1" width="100%" cellspacing="0" cellpadding="5">
            <tr>
                <th>Tanggal</th>
                <th>Keterangan</th>
                <th>Tagihan</th>
                <th>Bayar</th>
            </tr>
            ${
                s.histori.map(h=>`
                <tr>
                    <td>${new Date(h.timestamp).toLocaleDateString('id-ID')}</td>
                    <td>${h.keterangan}</td>
                    <td>${h.tipe==="tagihan"?formatRupiah(h.nominal):"-"}</td>
                    <td>${h.tipe==="masuk"?formatRupiah(h.nominal):"-"}</td>
                </tr>`).join('')
            }
        </table>
    `;

    document.getElementById('print-content').innerHTML = html;
    document.getElementById('print-date').textContent = new Date().toLocaleDateString('id-ID');

    window.print();
}

/* ===============================
    INIT
=================================*/
loadSiswaSelect();
renderDaftar();
updateDashboard();

</script>

</body>
</html>
